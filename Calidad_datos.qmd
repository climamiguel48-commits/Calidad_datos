---
title: "**Informe de control de calidad de datos climáticos - Parcela 3**"
author: "Ing. Miguel Silva"
date: "today"
---

# Introducción

En este informe se presenta el control de calidad de la base de datos climáticos registrada en la Parcela 3, a partir del archivo `Datos_Parcela_3.xlsx`.

El objetivo principal es identificar y cuantificar:

-   Datos faltantes por variable.\

-   Valores fuera de rangos físicos razonables.\

-   Registros atípicos que puedan comprometer análisis posteriores (balance de energía, estimación de ET, etc.).

-   Visualizar el comportamiento temporal de las variables.

# Descripción general de la base de datos

La base de datos esta conformada por los registros horarios de las siguientes variables:

**Variables meteorológicas**:

-   Temperatura (°C)

-   Humedad relativa (%)

-   Velocidad del viento (m/s)

-   Dirección del viento (°)

-   Presión atmosférica (mbar)

-   Radiación global (Wm-2)

-   Precipitación (mm)

**Variables de flujos de energía**:

-   Temperatura superficial (°C)

-   Flujo de energía en el suelo (Wm-2)

-   Radiación Neta (Wm-2)

-   Temperatura termocupla 1 (°C)

-   Temperatura termocupla 2 (°C)

-   Humedad del suelo a los 5 cm (m3/m3)

-   Humedad del suelo a los 40 cm (m3/m3)

Para su procesamiento preliminar se aplica lo siguiente:

```{r}
#| label: setup
#| include: true

# Cargar paquetes
library(readxl)
library(dplyr)
library(lubridate)
library(ggplot2)
library(tidyr)
library(purrr)
library(readr)
library(ggpmisc)
library(openair)

# Lectura del archivo original
datos_brutos <- readxl::read_excel("Datos_Parcela_3.xlsx")

# Renombrar variables según indicaciones
datos_brutos <- datos_brutos %>%
  rename(
    Radiacion_global_Wm2          = SlrFD_W_Avg,
    Precipitacion_mm             = Rain_mm_Tot,
    Rayos_conteo                 = Strikes_Tot,
    Velocidad_viento_ms          = WS_ms_Avg,
    Direccion_viento_grados      = WindDir,
    Rachas_ms                    = MaxWS_ms_Avg,
    Temperatura_aire_C           = AirT_C_Avg,
    Presion_atmosferica_mbar     = BP_mbar_Avg,
    Humedad_relativa_porc        = RH,
    Radiacion_global_MJm2        = SlrTF_MJ_Tot,
    Temperatura_superficie_C     = SBT_C_Avg,
    Flujo_energia_suelo_Wm2      = SHF_Avg,
    Radiacion_neta_Wm2           = NR_Wm2_Avg,
    Temperatura_termocupla1_C    = Temp_TC1_C_Avg,
    Temperatura_termocupla2_C    = Temp_TC2_C_Avg,
    Humedad_suelo_5cm_m3m3       = SWC_5CM_Avg,
    Humedad_suelo_40cm_m3m3      = SWC_40CM_Avg
  ) %>%
  mutate(
    fecha_hora = ymd_hms(fecha_hora),
    fecha      = as_date(fecha)
  ) %>%
  # Forzar variables climáticas a numérico
  mutate(
    Radiacion_global_Wm2        = as.numeric(Radiacion_global_Wm2),
    Precipitacion_mm            = as.numeric(Precipitacion_mm),
    Rayos_conteo                = as.numeric(Rayos_conteo),
    Velocidad_viento_ms         = as.numeric(Velocidad_viento_ms),
    Direccion_viento_grados     = as.numeric(Direccion_viento_grados),
    Rachas_ms                   = as.numeric(Rachas_ms),
    Temperatura_aire_C          = as.numeric(Temperatura_aire_C),
    Presion_atmosferica_mbar    = as.numeric(Presion_atmosferica_mbar),
    Humedad_relativa_porc       = as.numeric(Humedad_relativa_porc),
    Radiacion_global_MJm2       = as.numeric(Radiacion_global_MJm2),
    Temperatura_superficie_C    = as.numeric(Temperatura_superficie_C),
    Flujo_energia_suelo_Wm2     = as.numeric(Flujo_energia_suelo_Wm2),
    Radiacion_neta_Wm2          = as.numeric(Radiacion_neta_Wm2),
    Temperatura_termocupla1_C   = as.numeric(Temperatura_termocupla1_C),
    Temperatura_termocupla2_C   = as.numeric(Temperatura_termocupla2_C),
    Humedad_suelo_5cm_m3m3      = as.numeric(Humedad_suelo_5cm_m3m3),
    Humedad_suelo_40cm_m3m3     = as.numeric(Humedad_suelo_40cm_m3m3)
  ) %>%
  arrange(fecha_hora)
  
```

```{r}

#| label: resumen-temporal
#| echo: true

datos_brutos %>%
summarise(
fecha_inicio = min(fecha_hora, na.rm = TRUE),
fecha_fin = max(fecha_hora, na.rm = TRUE),
n_registros = n()
)

#| label: resumen-completitud
#| echo: true

datos_brutos %>%
summarise(
n_Temperatura_aire_C = sum(!is.na(Temperatura_aire_C)),
n_Humedad_relativa_porc = sum(!is.na(Humedad_relativa_porc)),
n_Precipitacion_mm = sum(!is.na(Precipitacion_mm)),
n_Velocidad_viento_ms = sum(!is.na(Velocidad_viento_ms)),
n_Radiacion_neta_Wm2 = sum(!is.na(Radiacion_neta_Wm2)),
n_Radiacion_global_Wm2 = sum(!is.na(Radiacion_global_Wm2)),
n_Temperatura_superficie_C = sum(!is.na(Temperatura_superficie_C)),
n_Humedad_suelo_5cm_m3m3 = sum(!is.na(Humedad_suelo_5cm_m3m3)),
n_Humedad_suelo_40cm_m3m3 = sum(!is.na(Humedad_suelo_40cm_m3m3))
)

```

# Análisis exploratorio

Este análisis primero identifica el período temporal cubierto, el número de registros y variables, y determina qué columnas contienen información numérica. Luego calcula estadísticas descriptivas básicas; media, mediana, desviación estándar, mínimos, máximos y cantidad de datos faltantes para todas las variables, permitiendo detectar rangos típicos, dispersión y posibles anomalías. Finalmente, cuantifica los valores ausentes por variable, lo cual ayuda a evaluar la completitud del conjunto de datos antes de aplicar controles de calidad más estrictos.

```{r}
#| label: fun-analisis-exploratorio

analisis_exploratorio <- function(datos) {
resultados_ae <- list()

#Información básica (proteger si fecha_hora es todo NA)

fecha_min <- ifelse(all(is.na(datos$fecha_hora)), NA, min(datos$fecha_hora, na.rm = TRUE))
fecha_max <- ifelse(all(is.na(datos$fecha_hora)), NA, max(datos$fecha_hora, na.rm = TRUE))
duracion <- ifelse(
is.na(fecha_min) | is.na(fecha_max),
NA,
as.numeric(difftime(fecha_max, fecha_min, units = "days"))
)

resultados_ae$info_basica <- list(
n_filas = nrow(datos),
n_columnas = ncol(datos),
fecha_inicio = fecha_min,
fecha_fin = fecha_max,
duracion_dias = duracion
)

#Variables numéricas disponibles

vars_numericas <- datos %>% dplyr::select(where(is.numeric)) %>% colnames()
resultados_ae$variables_numericas <- vars_numericas

#Variables principales

vars_principales <- c(
"Radiacion_global_Wm2",
"Precipitacion_mm",
"Rayos_conteo",
"Velocidad_viento_ms",
"Direccion_viento_grados",
"Rachas_ms",
"Temperatura_aire_C",
"Presion_atmosferica_mbar",
"Humedad_relativa_porc",
"Radiacion_global_MJm2",
"Temperatura_superficie_C",
"Flujo_energia_suelo_Wm2",
"Radiacion_neta_Wm2",
"Temperatura_termocupla1_C",
"Temperatura_termocupla2_C",
"Humedad_suelo_5cm_m3m3",
"Humedad_suelo_40cm_m3m3"
)

#Estadísticas descriptivas

estadisticas <- list()
for (var in vars_principales) {
if (var %in% colnames(datos)) {
estadisticas[[var]] <- list(
media = mean(datos[[var]], na.rm = TRUE),
mediana = median(datos[[var]], na.rm = TRUE),
desviacion = sd(datos[[var]], na.rm = TRUE),
min = min(datos[[var]], na.rm = TRUE),
max = max(datos[[var]], na.rm = TRUE),
nas = sum(is.na(datos[[var]]))
)
}
}
resultados_ae$estadisticas <- estadisticas

#Conteo de valores faltantes

na_count <- colSums(is.na(datos))
resultados_ae$valores_faltantes <- na_count[na_count > 0]

return(resultados_ae)
}

```

# Control de calidad

Las reglas de control de calidad aplicadas en este informe son:

**Continuidad temporal**

Verificación de que la serie está ordenada y sin duplicados en fecha_hora.

Rangos físicos razonables (pueden ajustarse a tus criterios locales):

Temperatura_aire_C: -10 a 45 °C

Humedad_relativa_porc: 0 a 100 %

Precipitacion_mm: ≥ 0 mm

Velocidad_viento_ms: ≥ 0 m/s

Radiacion_neta_Wm2: -200 a 1000 W/m²

**Tratamiento de datos**

Los valores fuera de rango se marcan mediante flags y, en la base validada, se reemplazan por NA para evitar su uso directo en análisis.

```{r}
#| label: fun-control-calidad

control_calidad <- function(datos) {
resultados_cc <- list()

#Límites físicos

limites <- list(
Temperatura_aire_C = c(-10, 45),
Humedad_relativa_porc = c(0, 100),
Velocidad_viento_ms = c(0, 50),
Radiacion_global_Wm2 = c(0, 1500),
Precipitacion_mm = c(0, 100),
Humedad_suelo_5cm_m3m3 = c(0, 0.6),
Humedad_suelo_40cm_m3m3 = c(0, 0.6)
)

#Fuera de rango

fuera_rango <- list()
for (var in names(limites)) {
if (var %in% colnames(datos)) {
idx <- which(datos[[var]] < limites[[var]][1] | datos[[var]] > limites[[var]][2])
fuera_rango[[var]] <- list(
n_fuera_rango = length(idx),
porcentaje = round(length(idx) / nrow(datos) * 100, 2)
)
}
}
resultados_cc$fuera_rango <- fuera_rango

#Atípicos por IQR

atipicos_iqr <- list()
variables_verificar <- c(
"Radiacion_global_Wm2",
"Precipitacion_mm",
"Rayos_conteo",
"Velocidad_viento_ms",
"Direccion_viento_grados",
"Rachas_ms",
"Temperatura_aire_C",
"Presion_atmosferica_mbar",
"Humedad_relativa_porc",
"Radiacion_global_MJm2",
"Temperatura_superficie_C",
"Flujo_energia_suelo_Wm2",
"Radiacion_neta_Wm2",
"Temperatura_termocupla1_C",
"Temperatura_termocupla2_C",
"Humedad_suelo_5cm_m3m3",
"Humedad_suelo_40cm_m3m3"
)

for (var in variables_verificar) {
if (var %in% colnames(datos)) {
Q1 <- quantile(datos[[var]], 0.25, na.rm = TRUE)
Q3 <- quantile(datos[[var]], 0.75, na.rm = TRUE)
IQR_val <- Q3 - Q1
lower <- Q1 - 1.5 * IQR_val
upper <- Q3 + 1.5 * IQR_val
idx_atip <- which(datos[[var]] < lower | datos[[var]] > upper)
atipicos_iqr[[var]] <- list(
n_atipicos = length(idx_atip),
porcentaje = round(length(idx_atip) / nrow(datos) * 100, 2)
)
}
}
resultados_cc$atipicos_iqr <- atipicos_iqr

#Completitud de variables esenciales

vars_esenciales <- c(
"Radiacion_global_Wm2",
"Precipitacion_mm",
"Rayos_conteo",
"Velocidad_viento_ms",
"Direccion_viento_grados",
"Rachas_ms",
"Temperatura_aire_C",
"Presion_atmosferica_mbar",
"Humedad_relativa_porc",
"Radiacion_global_MJm2",
"Temperatura_superficie_C",
"Flujo_energia_suelo_Wm2",
"Radiacion_neta_Wm2",
"Temperatura_termocupla1_C",
"Temperatura_termocupla2_C",
"Humedad_suelo_5cm_m3m3",
"Humedad_suelo_40cm_m3m3"
)

completitud <- sapply(vars_esenciales, function(x) {
if (x %in% colnames(datos)) {
round(sum(!is.na(datos[[x]])) / nrow(datos) * 100, 2)
} else {
NA
}
})
resultados_cc$completitud <- completitud

#Saltos temporales distintos a 1 hora

datos2 <- datos %>%
arrange(fecha_hora) %>%
mutate(diff_tiempo_h = as.numeric(difftime(fecha_hora, lag(fecha_hora), units = "hours")))

saltos_tiempo <- which(datos2$diff_tiempo_h != 1 & !is.na(datos2$diff_tiempo_h))
resultados_cc$saltos_temporales <- length(saltos_tiempo)

return(resultados_cc)
}

#| label: crear-datos-qc
#| echo: true

#Rangos para flags (coherentes con la metodología)

rango_temp <- c(-10, 45)
rango_hr <- c(0, 100)
rango_pp <- c(0, Inf)
rango_viento <- c(0, Inf)
rango_rn <- c(-200, 1000)

datos_qc <- datos_brutos %>%
mutate(
flag_temp_rango = case_when(
is.na(Temperatura_aire_C) ~ "na",
Temperatura_aire_C < rango_temp[1] | Temperatura_aire_C > rango_temp[2] ~ "fuera_rango",
TRUE ~ "ok"
),
flag_hr_rango = case_when(
is.na(Humedad_relativa_porc) ~ "na",
Humedad_relativa_porc < rango_hr[1] | Humedad_relativa_porc > rango_hr[2] ~ "fuera_rango",
TRUE ~ "ok"
),
flag_pp_rango = case_when(
is.na(Precipitacion_mm) ~ "na",
Precipitacion_mm < rango_pp[1] ~ "negativa",
TRUE ~ "ok"
),
flag_ws_rango = case_when(
is.na(Velocidad_viento_ms) ~ "na",
Velocidad_viento_ms < rango_viento[1] ~ "negativa",
TRUE ~ "ok"
),
flag_rn_rango = case_when(
is.na(Radiacion_neta_Wm2) ~ "na",
Radiacion_neta_Wm2 < rango_rn[1] | Radiacion_neta_Wm2 > rango_rn[2] ~ "fuera_rango",
TRUE ~ "ok"
)
)

```

# Resultados

**Resultados del análisis exploratorio**

```{r}
#| label: ejecutar-analisis-exploratorio
#| echo: true

resultados_ae <- analisis_exploratorio(datos_brutos)

#Info básica en tabla

info_basica <- as.data.frame(resultados_ae$info_basica)
info_basica

#| label: estadisticas-principales
#| echo: true

estadisticas_df <- purrr::map_dfr(
resultados_ae$estadisticas,
~ as.data.frame(.x),
.id = "variable"
)

estadisticas_df

#| label: valores-faltantes
#| echo: true

valores_faltantes_df <- data.frame(
variable = names(resultados_ae$valores_faltantes),
n_na = as.numeric(resultados_ae$valores_faltantes)
)

valores_faltantes_df

```

**Resumen de flags por variable**

```{r}

#| label: resumen-flags
#| echo: true

resumen_flags <- datos_qc %>%
summarise(
temp_ok = sum(flag_temp_rango == "ok", na.rm = TRUE),
temp_fuera = sum(flag_temp_rango == "fuera_rango", na.rm = TRUE),
temp_na = sum(flag_temp_rango == "na", na.rm = TRUE),

hr_ok       = sum(flag_hr_rango == "ok",            na.rm = TRUE),
hr_fuera    = sum(flag_hr_rango == "fuera_rango",   na.rm = TRUE),
hr_na       = sum(flag_hr_rango == "na",            na.rm = TRUE),

pp_ok       = sum(flag_pp_rango == "ok",            na.rm = TRUE),
pp_negativa = sum(flag_pp_rango == "negativa",      na.rm = TRUE),
pp_na       = sum(flag_pp_rango == "na",            na.rm = TRUE),

ws_ok       = sum(flag_ws_rango == "ok",            na.rm = TRUE),
ws_negativa = sum(flag_ws_rango == "negativa",      na.rm = TRUE),
ws_na       = sum(flag_ws_rango == "na",            na.rm = TRUE),

rn_ok       = sum(flag_rn_rango == "ok",            na.rm = TRUE),
rn_fuera    = sum(flag_rn_rango == "fuera_rango",   na.rm = TRUE),
rn_na       = sum(flag_rn_rango == "na",            na.rm = TRUE)

)

resumen_flags

#| label: resumen-flags-porcentaje
#| echo: true

n_total <- nrow(datos_qc)

resumen_flags_porcentaje <- resumen_flags %>%
mutate(across(everything(), ~ .x / n_total * 100))

resumen_flags_porcentaje

#| label: resumen-flags-porcentaje
#| echo: true

n_total <- nrow(datos_qc)

resumen_flags_porcentaje <- resumen_flags %>%
mutate(across(everything(), ~ .x / n_total * 100))

#resumen_flags_porcentaje

```

**Resultados del control de calidad**

```{r}
#| label: ejecutar-control-calidad
#| echo: true

resultados_cc <- control_calidad(datos_brutos)

fuera_rango_df <- purrr::map_dfr(
resultados_cc$fuera_rango,
~ as.data.frame(.x),
.id = "variable"
)

atipicos_iqr_df <- purrr::map_dfr(
resultados_cc$atipicos_iqr,
~ as.data.frame(.x),
.id = "variable"
)

completitud_df <- data.frame(
variable = names(resultados_cc$completitud),
completitud = as.numeric(resultados_cc$completitud)
)

list(
fuera_rango = fuera_rango_df,
atipicos_iqr = atipicos_iqr_df,
completitud = completitud_df,
saltos_tiempo = resultados_cc$saltos_temporales
)

```

# Visualización gráfica de las variables

**Series temporales facetadas de variables principales**

```{r}

#| label: graf-series-temporales-facetas
#| fig-cap: "Series temporales de variables meteorológicas (facetadas por variable)."
#| echo: false

datos_largo <- datos_brutos %>%
dplyr::select(
fecha_hora,
Radiacion_global_Wm2,
Temperatura_aire_C,
Humedad_relativa_porc,
Precipitacion_mm,
Velocidad_viento_ms,
Presion_atmosferica_mbar
) %>%
tidyr::pivot_longer(
cols = -fecha_hora,
names_to = "Variable",
values_to = "Valor"
)

series_temporales <- ggplot(datos_largo, aes(x = fecha_hora, y = Valor, color = Variable)) +
geom_line(linewidth = 0.3, alpha = 0.8) +
facet_wrap(~ Variable, scales = "free_y", ncol = 2) +
scale_color_manual(values = c(
"Humedad_relativa_porc" = "blue",
"Presion_atmosferica_mbar" = "darkgreen",
"Temperatura_aire_C" = "red",
"Precipitacion_mm" = "cyan",
"Radiacion_global_Wm2" = "orange",
"Velocidad_viento_ms" = "purple"
)) +
labs(
title = "Series temporales de variables meteorológicas - Parcela 3",
x = "Fecha y hora",
y = ""
) +
theme_bw() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none"
)

series_temporales

```

**Humedad del suelo en el tiempo (2 profundidades)**

```{r}

#| label: graf-humedad-suelo-tiempo
#| fig-cap: "Humedad del suelo a 5 y 40 cm en el tiempo."
#| echo: false

datos_suelo <- datos_brutos %>%
dplyr::select(
fecha_hora,
Humedad_suelo_5cm_m3m3,
Humedad_suelo_40cm_m3m3
) %>%
tidyr::pivot_longer(
cols = -fecha_hora,
names_to = "Profundidad",
values_to = "Humedad"
)

Humedad_Suelo <- ggplot(datos_suelo, aes(x = fecha_hora, y = Humedad, color = Profundidad)) +
geom_line(linewidth = 0.5) +
labs(
title = "Humedad del suelo a diferentes profundidades",
x = "Fecha y hora",
y = "Humedad (m³/m³)",
color = "Profundidad"
) +
theme_bw() +
theme(legend.position = "top")

Humedad_Suelo

```

**Precipitación diaria acumulada**

```{r}
#| label: graf-precipitacion-diaria
#| fig-cap: "Precipitación diaria acumulada."
#| echo: false

Precipitacion <- datos_brutos %>%
mutate(
fecha = as.Date(fecha_hora),
Precipitacion_mm = as.numeric(Precipitacion_mm)
) %>%
group_by(fecha) %>%
summarise(
Precipitacion_diaria = sum(Precipitacion_mm, na.rm = TRUE),
.groups = "drop"
) %>%
ggplot(aes(x = fecha, y = Precipitacion_diaria)) +
geom_col(alpha = 0.7) +
labs(
title = "Precipitación diaria acumulada",
x = "Fecha",
y = "Precipitación (mm)"
) +
theme_bw()

Precipitacion

```

**Rosa de vientos**

```{r}
#| label: graf-rosa-vientos
#| fig-cap: "Rosa de vientos (dirección y velocidad del viento)."
#| echo: false

if (requireNamespace("openair", quietly = TRUE)) {
wind_data <- datos_brutos %>%
dplyr::select(
ws = Velocidad_viento_ms,
wd = Direccion_viento_grados
) %>%
dplyr::filter(!is.na(ws), !is.na(wd))

openair::windRose(
wind_data,
ws = "ws",
wd = "wd",
main = "Rosa de vientos - Parcela 3",
paddle = FALSE,
key.header = "Velocidad (m/s)"
)
} else {
plot.new()
text(0.5, 0.5, "Paquete 'openair' no instalado", cex = 1.2)
}
```

**Distribución de temperaturas**

```{r}
#| label: graf-distribucion-temperaturas
#| fig-cap: "Distribución de temperaturas del aire, superficie y termocuplas."
#| echo: false

datos_temp_2 <- datos_brutos %>%
dplyr::select(
Temperatura_aire_C,
Temperatura_superficie_C,
Temperatura_termocupla1_C,
Temperatura_termocupla2_C
) %>%
tidyr::pivot_longer(
cols = everything(),
names_to = "Variable",
values_to = "Valor"
)

etiquetas <- c(
"Temperatura_aire_C" = "Temp aire",
"Temperatura_superficie_C" = "Temp superficie",
"Temperatura_termocupla1_C" = "Termocupla 1",
"Temperatura_termocupla2_C" = "Termocupla 2"
)

datos_temp_2$Variable_etiqueta <- factor(
datos_temp_2$Variable,
levels = names(etiquetas),
labels = etiquetas
)

distribucion_temperaturas_2 <- ggplot(
datos_temp_2,
aes(x = Variable_etiqueta, y = as.numeric(Valor), fill = Variable_etiqueta)
) +
geom_boxplot(
outlier.color = "red",
outlier.shape = 16,
outlier.size = 1.2
) +
stat_summary(
fun = mean,
geom = "point",
shape = 18,
size = 3
) +
labs(
title = "Distribución de temperaturas (boxplot)",
x = "Variables",
y = "Temperatura (°C)"
) +
theme_bw() +
theme(
legend.position = "none",
axis.text.x = element_text(angle = 45, hjust = 1)
)

distribucion_temperaturas_2
```

**Generación de base de datos validada**

```{r}
#| label: generar-base-validada
#| echo: true

datos_validados <- datos_qc %>%
mutate(
Temperatura_aire_C = if_else(flag_temp_rango == "ok", Temperatura_aire_C, NA_real_),
Humedad_relativa_porc = if_else(flag_hr_rango == "ok", Humedad_relativa_porc, NA_real_),
Precipitacion_mm = if_else(flag_pp_rango == "ok", Precipitacion_mm, NA_real_),
Velocidad_viento_ms = if_else(flag_ws_rango == "ok", Velocidad_viento_ms, NA_real_),
Radiacion_neta_Wm2 = if_else(flag_rn_rango == "ok", Radiacion_neta_Wm2, NA_real_)
)

readr::write_csv(datos_validados, "Datos_Parcela_3_validado.csv")

datos_validados %>%
summarise(
n_temp_validas = sum(!is.na(Temperatura_aire_C)),
n_hr_validas = sum(!is.na(Humedad_relativa_porc)),
n_pp_validas = sum(!is.na(Precipitacion_mm)),
n_ws_validas = sum(!is.na(Velocidad_viento_ms)),
n_rn_validas = sum(!is.na(Radiacion_neta_Wm2))
)

```

------------------------------------------------------------------------

`{#}`
